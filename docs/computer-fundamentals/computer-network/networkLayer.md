---
sidebar_position: 3
---

# 网络层

决定数据在网络传输的路径

网络层中的设备：路由器

1.网络层IP协议
  - IP协议
  - 子网划分
  - 简单路由过程
2. 其他协议
  - ARP与RARP协议
  - ICMP协议
3. IP的路由算法
  - 路由的概述
  - 内部网关路由协议
  - 外部网关路由协议 

## IP协议

**虚拟互联网络**

- 实际的计算机网络是错综复杂的
- 物理设备通过使用1P协议，屏蔽了物理网络之间的差异
- 当网络中的主机使用IP协议连接时，则无需关注网络细节

**IP协议**

- 1P协议使得复杂的实际网络变为一个虚拟互连的网络
- IP协议使得网络层可以屏蔽底层细节而专注网络层的数据转发
- IP协议**解决了在虚拟网络中数据报传输路径的问题**


**IP地址**

- IP地址长度为32位，常分成4个8位
- IP地址常使用点分十进制来表示(0~255.0~255.0~255.0~255)

114.114.114.114
1.1.1.1
8.8.8.8
70.12.34.34
255.255.255.255
111.111.111.111


### IP 首部

头部大小为20到60字节。

![IP header](https://media.geeksforgeeks.org/wp-content/cdn-uploads/20200113154849/ip-v4-datagram-header.png)

**4位版本**

占4位，指的是IP协议的版本，通信双方的版本必须一致，当前主流版本是4，即IPv4，也有IPv6

**4位首部长度**

占4位，最大数值为15位，表示的是IP首部长度，单位是 “32位字〞（4个字节），也即是IP首部最大长度为60字节

**8位服务类型(TOS)**

占16位，最大数值为65535，表示的是IP数据报总长度（1P首部+IP数据）

*MTU*最大1500，超过则会进行分片

标识 标志 13位片偏移 主要用来进行分片

**8位生存时间(TTL)**

占8位，表明IP数据报文在网络中的寿命，每经过一个设备，TTL减1，当TTL=0时，网络设备必须丢弃该报文

**8位协议**

占8位，表明IP数据所携带的具体数据是什么协议的（如：TCP、 UDP等）

*协议*：

**16位首部校验和**

首部校验和：占16位，校验IP首部是否有出错

**32位源IP地址**

**32位目的IP地址**

- 选项options（若有）
- IP数据

### IP协议的转发流程

A-B之间的数据是怎么传输的？

**逐跳（hop-by-hop）**

**路由表**

类似于MAC地址表, **计算机或者路由器都拥有Mac地址表和路由表**

MAC地址 硬件接口
  A      E1
  B      E2
  C      E3

目的IP地址  下一跳IP地址
  IP1         IP4
  IP2         IP5
  IP3         IP6

**转发流程**

A --> E路由器 --> F路由器 --> C

- A发出目的地为C的IP数据报，查询路由表发现下一跳为E
- A将数据发送给E
- E查询路由表发现下一跳为F，将数据发送给F
- F查询路由表发现下一跳为C，将数据发送给C

结合网络层和数据链路层的转发流程

- A发出目的地为C的IP数据报，查询路由表发现下一跳为E
- A将IP数据报交给数据链路层，并告知目的地MAC地址是E
- 数据链路层填充源MAC地址A和目的MAC地址E
- 数据链路层通过物理层将数据发送给E
- E的数据链路层接收到数据帧，把帧数据交给网络层
- E查询路由表，发现下一跳为F
- E把数据报交给数据链路层，并告知目的MAC地址为F
- E的数据链路层封装数据帧并发送
- F的数据链路层接收到数据帧，把帧数据交给网络层
- F查询路由表，发现下一跳为C
- F把数据报交给数据链路层，并告知MAC地址为C
- F的数据链路层分装数据帧并发送

## ARP协议以及RARP协议

问题：路由器不知道C的MAC地址怎么办？

**ARP**：地址解析协议

网络层IP32位地址 ---ARP协议--- 数据链路层的MAC48位地址

ARP缓存表

IP地址       MAC地址

- ARP缓存表是ARP协议和RARP协议运行的关键
- ARP缓存表缓存了IP地址到硬件地址之间的映射关系
- ARP缓存表中的记录并不是永久有效的，有一定的期限

ARP使用

- ARP有缓存表，则使用缓存
- 没有缓存表，则会进行广播，来收录没有缓存的MAC地址


## IP地址的子网划分

- 分类的IP地址
- 划分子网的方法
- 未分类的编址

### 分类的IP地址

IP地址(32位) = 网络号 + 主机号

A类IP地址 = 网络号(8位并且首位是0) + 主机号(24位)
B类IP地址 = 网络号(16位并且首位是10) + 主机号(16位)
C类IP地址 = 网络号(24位并且首位是110) + 主机号(8位)
D类IP地址 = 1110
D类IP地址 = 1111


      最小网络号      最大网络号         子网数量        最小主机号     最大主机号        主机数量
A   0(00000000)   127(01111111)       2^7 - 2         0.0.1      255.255.254     2^24-2
B      128.1         191.255          2^14 - 1         0.1        255.254        2^16-2
C     192.0.1      223.255.255        2^21 - 1          1           254         2^8-2


**特殊的主机号**

- 主机号全为0，表示当前网络端
- 主机号全为1，表示广播地址，向当前网络段所有主机发消息


**特殊的网络号**

- A类地址网络段全0(00000000)表示特殊网络
- A类地址网络段后7位全1(01111111:127)表示回环地址
- B类地址网络段(10000000.00000000:128.0)是不可使用的
- C类地址网络段（192.0.0)是不可使用的


**回环地址**

> 127.0.0.1，通常被称为本地回环地址(Loopback Address)，不属于任何
> 一个有类别地址类。它代表设备的本地虚拟接口，所以默认被看作是永远
> 不会宕掉的接口。在Windows操作系统中也有相似的定义，所以通常在
> 安装网卡前就可以ping通这个本地回环地址。一般都会用来检查本地网络
> 协议、基本数据接口等是否正常的。

### 划分子网


IP地址(32位) = 网络号 + 子网号 + 主机号

193.10.10.0 划分子网过程

.00000000  193.10.10.0 - 193.10.10.127
.10000000  193.10.10.128~193.10.10.255

**子网掩码**：快速的判断IP地址属于哪个网络号

- 子网掩码和IP地址一样，都是32位
- 子网掩码由连续的1和连续的O组成
- 某一个子网的子网掩码具备网络号位数个连续的1


A类IP地址 = 网络号(8位并且首位是0) + 主机号(24位)
A类IP地址子网掩码 = 11111111 + 24 * 0  = 255.0.0.0       

B类IP地址 = 网络号(16位并且首位是0) + 主机号(16位)
B类IP地址子网掩码 = 1 * 16 + 16 * 0    = 255.255.0.0

C类IP地址 = 网络号(24位并且首位是0) + 主机号(8位)
C类IP地址子网掩码 = 1 * 24 + 8 * 0     = 255.255.255.0

193.10.10.0 划分子网过程

.00000000  193.10.10.0 - 193.10.10.127
.10000000  193.10.10.128~193.10.10.255

子网的子网掩码

网络号 + 子网号 = 25位个1 + 7位个0 


### 无分类编址CIDR

比原来的划分更加灵活

- CIDR中没有A、B、C类网络号、和子网划分的概念
- CIDR将网络前缀相同的1P地址称为一个 “CIDR地址块”

网络前缀    主机号

CIDR前缀长度      掩码点分十进制        地址数
/13              255.248.0.0         512K
/14              255.252.0.0         256K
/15              255.254.0.0         128K
/16              255.255.0.0         64K
/17              255.255.128.0       32K
/18              255.255.192.0       16K
/19              255.255.224.0        8K


## 网络地址转换NAT技术

- IPv4最多只有40+亿个P地址
- 早期IP地址的不合理规划导致/P号浪费

1. 内网地址 - 内部机构
  - A： 10.0.0.0~10.255.255.255（支持干万数量级设备）
  - B： 172.16.0.0~172.31.255.255（支持百万数量级设备）
  - C:  192.168.0.0~192.158.255.255（支持万数量级设备）
2. 外网地址 - 全球范围


**内网多个设备使用同一个外网P请求外网的服务，外部怎么知道具体是哪个设备在请求的？**


**NAT技术**
- 网络地址转换NAT(Network Address Translation)
- NAT技术用于多个主机通过一个公有IP访问互联网的私有网络中
- NAT减缓了IP地址的消耗，但是增加了网络通信的复杂度

**转换过程**

外网地址：173.21.59.10
内网地址：
  - 192.168.2.11
  - 192.168.2.10

方向    旧的地址和端口号      新的地址与端口号
出    192.168.2.11:6666   173.21.59.10:16666
出    192.168.2.10:7777   173.21.59.10:17777
入    173.21.59.10:16666  192.168.2.11:6666
入    173.21.59.10:17777  192.168.2.10:7777

**映射表NA(P)T**发生的在路由器


## ICMP协议

网际控制报文协议 (Internet Control Message Protocol)
ICMP协议可以报告错误信息或者异常情况


**ICMP报文首部**

- 8位类型
- 8位代码
- 16位校验和

1. 差错报告报文
2. 询问报文

### ICMP协议应用

**ping应用**
**traceRoute应用**TraceRoute可以探测IP数据报在网络中走过的路径






