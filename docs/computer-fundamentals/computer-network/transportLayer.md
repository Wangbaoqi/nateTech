---
sidebar_position: 4
---

# 传输层

网络通信：进程与进程之间的通信

## 概述

使用端口(Port)来标记不同的网络进程
端口(Port)使用16比特位表示(0~65535)

FTP HTTP HTTPS DNS TELNET
21   80   443  53    23

## 协议


### UDP

**UDP**：User DataGram protocol 用户数据包协议, 是一种简单的协议

**数据包DataGram**: 不拆分 不合并

**UDP首部**：

- 16位源端口号    16位目的端口号
- 16位UDP长度    16位UDP校验和
- UDP数据

**UDP特点**

- 无连接协议
- 不保证可靠的交付数据
- 面向报文传输（不会进行任何的处理）
- 没有拥塞控制
- 首部开销小 



### TCP

**TCP transmission Control Protocol**: 传输控制协议

**TCP特点**

- 面向连接的协议
- 连接有两端（点对点的通信）
- 提供可靠的传输服务
- 全双工的协议
- 面向字节流的协议


**字节流和报文**：将报文截取部分或者以字节的方式

**TCP首部**: 至少20bytes

- 16位源端口号               16位目的端口号
- 序号
- 确认号
- 数据偏移 保留字段 TCP标记        窗口
- 校验和                       紧急指针
- TCP选项

序号：32bits，传输的字节，一个字节一个序号
确认号：32bits，期望收到数据的首字节序号，比如：确认号为n,表示n-1的数据都已经收到了
数据偏移：4bits，0-15， 数据偏移首部的距离
TCP标记：6bits, 
  - URG：URgent紧急位， URG=1 紧急数据
  - ACK：Acknowledgement ACK=1 确认号生效
  - PSH：Push 推送为 PSH=1 尽快的把数据交付给应用层
  - RST：Reset 重置位 RST=1 重新建立连接
  - SYN：Synchronization 同步位 SYN=1 连接请求报文
  - FIN：Finish 终止位 FIN=1 释放连接
窗口：16bits 指明允许对方发送的数据量
校验和
紧急指针：URG=1 指定紧急数据在报文的位置
TCP选项：最多40个字节，未来的拓展

- 流量控制
- 拥塞控制
- 三次握手
- 四次挥手

#### 可靠传输的基本原理

**1. 停止等待协议**

- 发送的消息在路上丢失了
- 确认的消息在路上丢失了
- 确认的消息很久才收到

**定时器**
- 超时定时器
- 坚持定时器

**特点**


- 简单的可靠传输协议
- 对信道的利用率不高


**2. 连续ARQ协议**

**ARQ** Automatic Repeat ReQuest 自动重传请求

*既然单个发送和确认效率低，可不可以批量发送和确认？*

**滑动窗口**
**累计确认**

**3. TCP 可靠传输**

- TCP可靠传输基于连续ARQ协议
- TCP的滑动窗口以字节为单位
- **选择重选**需要指定重传的序号


**4. TCP协议的流量控制**

- 流量控制指让发送方发送速率不要太快
- 流量控制是使用滑动窗口来实现的
- 考虑点对点的通信量的控制


如果出现**死锁**（发送方和接收方都在等待），则使用坚持定时器

**坚持定时器**

- 当接收到窗口为0的消息，则启动坚持定时器
- 坚持定时器每隔一段时间发送一个窗口探测报文（询问窗口有没有变大）


**5. TCP协议的拥塞控制**

原因：

- 一条数据链路经过非常多的设备
- 数据链路中各个部分都有可能成为网路传输的瓶颈
- 考虑整个网络，全局性的考虑

判断是否拥塞的方法：

1. 报文的超时（不一定是由拥塞引起的）

算法：

**慢启动**

- 由小到大逐渐增加发送数据量
- 每收到一个报文确认，就加一

指数级的发送报文

**拥塞避免算法**

- 维护一个拥塞窗口的变量
- 只要网络不拥塞，就试探着将拥塞窗口调大

指数增长


#### TCP 连接的建立

**1. 三次握手的过程**

TCP标记：
- SYN
- ACK
- FIN

      发送方                                      接收方

                    SYN=1 seq=x   --->          

              SYN=1 ACK=1 seq=y ack=x+1   <----

              ACK=1 ack=y+1 seg=x+1 ---> 


**为什么需要三次握手而不是两次？**